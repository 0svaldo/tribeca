<!DOCTYPE html>
<html ng-app="projectApp">
<head>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
</head>
<body ng-controller="uiCtrl">

<script type="text/ng-template" id="order_form.html">
    <form style="margin: 20px" class="form-horizontal" novalidate role="form">
        <div class="form-group">
            <label>Exchange</label>
            <select class="form-control input-sm" ng-model="order.exchange" ng-options="v for (k,v) in availableExchanges"></select>
        </div>
        <div class="form-group">
            <label>Side</label>
            <select class="form-control input-sm" ng-model="order.side" ng-options="v for (k,v) in availableSides"></select>
        </div>
        <div class="form-group">
            <label>Price</label>
            <input class="form-control input-sm" type="number" ng-model="order.price" />
        </div>
        <div class="form-group">
            <label>Size</label>
            <input class="form-control input-sm" type="number" ng-model="order.quantity" />
        </div>
        <div class="form-group">
            <label>TIF</label>
            <select class="form-control input-sm" ng-model="order.timeInForce" ng-options="v for (k,v) in availableTifs"></select>
        </div>
        <div class="form-group">
            <label>Type</label>
            <select class="form-control input-sm" ng-model="order.orderType" ng-options="v for (k,v) in availableOrderTypes"></select>
        </div>
        <button type="button" class="btn btn-success" ng-click="submitOrder()">Submit</button>
    </form>
</script>

<button type="button"
        class="btn btn-primary"
        style="float: right"
        mypopover popover-template="order_form.html"
        data-placement="bottom">Submit order</button>

<p>
    Connection: {{ connected }}
</p>

<p ng-repeat="(exch, book) in books">
    <b>{{ exch }}</b>: {{ book.bidSize|number:2 }} {{ book.bidPrice|number:2 }} X {{ book.askPrice|number:2 }} {{ book.askSize|number:2 }}
</p>

<table class="table table-striped table-hover table-condensed">
    <tr>
        <th>orderId</th>
        <th>time</th>
        <th>exchange</th>
        <th>orderStatus</th>
        <th>price</th>
        <th>quantity</th>
        <th>side</th>
        <th>type</th>
        <th>tif</th>
        <th>lastQuantity</th>
        <th>lastPrice</th>
        <th>leavesQuantity</th>
        <th>cumQuantity</th>
        <th>averagePrice</th>
        <th>liquidity</th>
        <th>msg</th>
        <th>cancel</th>
    </tr>
    <tr ng-repeat="order in orders_statuses|orderBy:'-time'">
        <td>{{ order.orderId }}</td>
        <td>{{ order.time|date:'M/d/yy h:mm:ss,sss' }}</td>
        <td>{{ availableExchanges[order.exchange] }}</td>
        <td>{{ availableOrderStatuses[order.orderStatus] }}</td>
        <td>{{ order.price|number:2 }}</td>
        <td>{{ order.quantity|number:4 }}</td>
        <td>{{ availableSides[order.side] }}</td>
        <td>{{ availableOrderTypes[order.type] }}</td>
        <td>{{ availableTifs[order.timeInForce] }}</td>
        <td>{{ order.lastQuantity|number:4 }}</td>
        <td>{{ order.lastPrice|number:2 }}</td>
        <td>{{ order.leavesQuantity|number:4 }}</td>
        <td>{{ order.cumQuantity|number:4 }}</td>
        <td>{{ order.averagePrice|number:2 }}</td>
        <td>{{ availableLiquidityTypes[order.liquidity]}}</td>
        <td>{{ order.rejectMessage || order.message }}</td>
        <td><button type="button" class="btn btn-danger btn-xs"  ng-click="cancelOrder(order)">cancel</button></td>
    </tr>
</table>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular.js"></script>
<script src="//cdn.socket.io/socket.io-1.1.0.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.10.0/ui-bootstrap-tpls.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script>
    angular.module('projectApp', ['ui.bootstrap'])
            .directive('mypopover', function ($compile, $templateCache) {
                var getTemplate = function (contentType, template_url) {
                    var template = '';
                    switch (contentType) {
                        case 'user':
                            template = $templateCache.get(template_url);
                            break;
                    }
                    return template;
                };
                return {
                    restrict: "A",
                    link: function (scope, element, attrs) {
                        var popOverContent = $compile("<div>" + getTemplate("user", attrs.popoverTemplate) + "</div>")(scope);
                        var options = {
                            content: popOverContent,
                            placement: attrs.dataPlacement,
                            html: true,
                            date: scope.date
                        };
                        $(element).popover(options).click(function (e) {
                            e.preventDefault();
                        });
                    }
                };
            });

    var uiCtrl = function($scope, $timeout, $log) {
        $scope.connected = false;
        $scope.books = {};
        $scope.orders_statuses = [];

        var refresh_timer = function () {
            $timeout(refresh_timer, 250);
        };
        $timeout(refresh_timer, 250);

        var socket = io();
        socket.on("hello", function() {
            $scope.connected = true;
            $log.info("connected");
        }).on("disconnect", function() {
            $scope.connected = false;
            $log.warn("disconnected");
        }).on("market-book", function(b) {
             $scope.books[b.exchangeName] = b;
        }).on('order-options', function(o) {
            angular.forEach(o, function(vals, key) {
                $scope[key] = vals;
            });
        }).on('order-status-report', function(o) {
            $scope.orders_statuses.push(o);
        });

        $scope.order = {};
        $scope.submitOrder = function() {
            socket.emit("submit-order", $scope.order);
        };

        $scope.cancelOrder = function(order) {
            socket.emit("cancel-order", order);
        };

        $log.info("started");
    };

</script>

</body>
</html>